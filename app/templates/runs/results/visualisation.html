<!DOCTYPE html>
<html lang="en">
  {% include 'head.html' %}

  <body class="bg-gray-50 dark:bg-slate-900">
    {% include 'header.html' %} {% include 'sidebar.html' %}
    <div class="mx-auto max-w-[90rem] px-1 py-1 sm:px-6 lg:px-0 lg:ps-64">
      <div class="mx-auto max-w-[85rem] px-4 sm:px-6 lg:px-8 lg:py-10">
        <div class="-m-1.5 overflow-x-auto">
          <div class="inline-block align-middle min-w-full">
            <div
              id="outer-parent"
              class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden px-6 py-4 dark:bg-slate-900 dark:border-gray-700"
            >
              <div>
                <h2
                  class="text-xl font-semibold text-gray-800 dark:text-gray-200"
                >
                  Run Results
                  <span class="text-gray-400 dark:text-gray-400"
                    >- Run {{run.id}} ({{location.name}})</span
                  >
                </h2>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Visualisation of rainfall intensity, day classification and
                  spill permission.
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Run created on : {{run.date.strftime('%d %B %Y | %H:%M:%S')}}
                </p>
              </div>

              <div>
                <div class="flex flex-row align-center my-1">
                  <div class="flex flex-row grow">
                    <label
                      for="start-selector"
                      class="font-semibold text-gray-800 dark:text-gray-200 py-1 mr-4"
                      >Start:</label
                    >
                    <select id="start-selector" class="border rounded-lg">
                      <option id="start-option-loading" value="0">
                        Loading...
                      </option>
                    </select>
                    <label
                      for="end-selector"
                      class="font-semibold text-gray-800 dark:text-gray-200 py-1 mx-4"
                      >End:</label
                    >
                    <select id="end-selector" class="border rounded-lg mr-4">
                      <option id="end-option-loading" value="0">
                        Loading...
                      </option>
                    </select>
                  </div>
                  <div class="flex flex-row">
                    <button
                      id="refresh-btn"
                      class="px-2 py-1 mr-1 inline-flex items-center gap-x-1 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
                    >
                      <svg
                        class="w-4 h-4 text-gray-800 dark:text-white"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke="currentColor"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17.651 7.65a7.131 7.131 0 0 0-12.68 3.15M18.001 4v4h-4m-7.652 8.35a7.13 7.13 0 0 0 12.68-3.15M6 20v-4h4"
                        />
                      </svg>

                      Refresh
                    </button>
                    <button
                      id="refresh-btn"
                      class="px-2 py-1 inline-flex items-center gap-x-1 text-sm font-semibold rounded-lg border border-transparent bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 disabled:pointer-events-none dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
                    >
                      <svg
                        class="w-4 h-4 text-gray-800 dark:text-white"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke="currentColor"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17.651 7.65a7.131 7.131 0 0 0-12.68 3.15M18.001 4v4h-4m-7.652 8.35a7.13 7.13 0 0 0 12.68-3.15M6 20v-4h4"
                        />
                      </svg>

                      Clear
                    </button>
                  </div>
                </div>
                <div
                  class="bg-white grow border rounded-lg"
                  id="vis-container"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script type="module">
        import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";


        let runTestID = {{ runTest.id }};
        let dateButtonDiv = document.getElementById('accordion');
        let visContainer = document.getElementById('vis-container');
        let colorMap = {
          "Substandard": "orange",
          "Satisfactory": "green",
          "Unsatisfactory": "red"
      }
        let earliest;
        let latest;
        // Get range of dates for the visualisation
        async function getRange() {
          if (earliest !== undefined || latest !== undefined) {
            return [earliest, latest];
          }
          try {
            const response = await fetch(`/api/results/timeseries/range?runTestID=${runTestID}`);
            const range = await response.json();
            // get earliest and latest date from range
            earliest = new Date(range.earliest_datetime);
            latest = new Date(range.latest_datetime);
            return [earliest, latest];

          } catch (error) {
            console.error('Error fetching data:', error);
          }
        }
        async function populatePage(){
          const [earliest, latest] = await getRange();
          const monthRange = [];
          var currentDate = new Date(earliest);
          while (currentDate <= latest) {
            monthRange.push(new Date(currentDate));
            currentDate.setMonth(currentDate.getMonth() + 1);
          }
          // Remove loading indiators
          document.getElementById('start-option-loading').remove();
          document.getElementById('end-option-loading').remove();

          const start_selector = document.getElementById('start-selector')
          const end_selector = document.getElementById('end-selector')
          monthRange.forEach((month) => {
            const monthOption = document.createElement('option')
            monthOption.innerHTML = `${month.toLocaleString('default', { month: 'long' })} ${month.getFullYear()}`;
            monthOption.value = (month.getTime()/1000);
            const startOption = monthOption.cloneNode(true);
            start_selector.appendChild(startOption);

            const endOption = monthOption.cloneNode(true);
            end_selector.appendChild(endOption);
          })
        generatePlot();
        }
        async function generatePlot(){
          const start_selector = document.getElementById('start-selector')
          const end_selector = document.getElementById('end-selector')
          let startDate = parseInt(start_selector.value);
          let endDate = parseInt(end_selector.value);
          if (startDate > endDate) {
            alert('Start date must be before end date');
            return;
          }
          // if start date is equal to end date, set end date to start date plus one month
          if (startDate === endDate) {
            endDate = startDate + 2678400;
          }
          // if range is greater than 1 year, alert user and return
          if (endDate - startDate > 31536000) {
            alert('Date range must be less than 1 year');
            return;
          }
          let data = await fetch(`/api/results/timeseries?runTestID=${runTestID}&startTime=${startDate}&endTime=${endDate}`)
          data = await data.json();
          data.forEach(d => {
            d.dateTime = new Date(d.dateTime);
            d.intensity = parseFloat(d.intensity)
          });
          const plot = Plot.plot({
            x: { type: "utc" },
            y: { label: "Intensity(mm)" },
            marks: [
              Plot.lineY(data, {
                x: "dateTime",
                y: "intensity",
                stroke: "blue",
                channels: {
                  Classification: "classification",
                  dateTime: d => d.dateTime.toLocaleString(),
                  Spill_Allowed: d => (d.spillAllowed === "YES" ? "Yes" : "No")
                },
                tip: true
              }),
              Plot.ruleX(data, {
                x: "dateTime",
                y: -1,
                stroke: d => colorMap[d.classification],
                title: d => d.classification
              }),
              Plot.ruleX(data, {
                x: "dateTime",
                y1: -1,
                y2: -2,
                stroke: d => (d.spillAllowed === "YES" ? "purple" : "white")
              }),
              Plot.crosshair(data, {
                x: d => d.dateTime,
                y: d => d.intensity
              }),
            ],
          });
          const div = document.querySelector("#vis-container");
          div.innerHTML = '';
          plot.classList.add('w-full');
          div.appendChild(plot);
        }
        document.getElementById('refresh-btn').addEventListener('click', () => generatePlot())
        window.addEventListener("load", (event) => {
          getRange();
          populatePage();
        });
    </script>
  </body>
</html>
