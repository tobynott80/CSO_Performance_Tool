<!DOCTYPE html>
<html lang="en">
  {% include 'head.html' %}

  <body class="bg-gray-50 dark:bg-slate-900">
    {% include 'header.html' %} {% include 'sidebar.html' %}
    <div class="mx-auto max-w-[90rem] px-1 py-1 sm:px-6 lg:px-0 lg:ps-64">
      <div class="mx-auto max-w-[85rem] px-4 sm:px-6 lg:px-8 lg:py-10">
        <div class="-m-1.5 overflow-x-auto">
          <div class="inline-block align-middle min-w-full">
            <div
              id="outer-parent"
              class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden px-6 py-4 dark:bg-slate-900 dark:border-gray-700"
            >
              <div>
                <div class="flex flex-row">
                  <h2
                    class="grow text-xl font-semibold text-gray-800 dark:text-gray-200"
                  >
                    Run Results
                    <span class="text-gray-400 dark:text-gray-400"
                      >- Run {{run.id}} ({{location.name}})</span
                    >
                  </h2>
                  <a
                    href="/{{ location.id }}/{{ run.id }}"
                    class="py-2 px-3 inline-flex justify-center items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-4 h-4"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M15.75 19.5 8.25 12l7.5-7.5"
                      />
                    </svg>
                    Back
                  </a>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Visualisation of rainfall intensity, day classification and
                  spill permission.
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Run created on : {{run.date.strftime('%d %B %Y | %H:%M:%S')}}
                </p>
              </div>

              <div>
                <div class="flex flex-row align-center my-1">
                  <div class="flex flex-row grow">
                    <label
                      for="start-selector"
                      class="inline-flex items-center gap-x-1 font-semibold text-gray-800 dark:text-gray-200 py-1 mr-4"
                    >
                      <svg
                        class="w-6 h-6 text-gray-800 dark:text-white"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke="currentColor"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 10h16m-8-3V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Zm3-7h.01v.01H8V13Zm4 0h.01v.01H12V13Zm4 0h.01v.01H16V13Zm-8 4h.01v.01H8V17Zm4 0h.01v.01H12V17Zm4 0h.01v.01H16V17Z"
                        />
                      </svg>
                      Start:</label
                    >
                    <select id="start-selector" class="my-1 border rounded-lg">
                      <option id="start-option-loading" value="0">
                        Loading...
                      </option>
                    </select>
                    <label
                      for="end-selector"
                      class="inline-flex items-center gap-x-1 font-semibold text-gray-800 dark:text-gray-200 py-1 mx-4"
                    >
                      <svg
                        class="w-6 h-6 text-gray-800 dark:text-white"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <path
                          fill="currentColor"
                          d="M4 9.05H3v2h1v-2Zm16 2h1v-2h-1v2ZM10 14a1 1 0 1 0 0 2v-2Zm4 2a1 1 0 1 0 0-2v2Zm-3 1a1 1 0 1 0 2 0h-2Zm2-4a1 1 0 1 0-2 0h2Zm-2-5.95a1 1 0 1 0 2 0h-2Zm2-3a1 1 0 1 0-2 0h2Zm-7 3a1 1 0 0 0 2 0H6Zm2-3a1 1 0 1 0-2 0h2Zm8 3a1 1 0 1 0 2 0h-2Zm2-3a1 1 0 1 0-2 0h2Zm-13 3h14v-2H5v2Zm14 0v12h2v-12h-2Zm0 12H5v2h14v-2Zm-14 0v-12H3v12h2Zm0 0H3a2 2 0 0 0 2 2v-2Zm14 0v2a2 2 0 0 0 2-2h-2Zm0-12h2a2 2 0 0 0-2-2v2Zm-14-2a2 2 0 0 0-2 2h2v-2Zm-1 6h16v-2H4v2ZM10 16h4v-2h-4v2Zm3 1v-4h-2v4h2Zm0-9.95v-3h-2v3h2Zm-5 0v-3H6v3h2Zm10 0v-3h-2v3h2Z"
                        />
                      </svg>

                      End:</label
                    >
                    <select
                      id="end-selector"
                      class="my-1 border rounded-lg mr-4"
                    >
                      <option id="end-option-loading" value="0">
                        Loading...
                      </option>
                    </select>
                  </div>
                  <div class="flex flex-row">
                    <label class="inline-flex items-center cursor-pointer mx-2">
                      <span class="mr-3 text-sm font-medium text-gray-900 dark:text-gray-300">Interval: 15m</span>
                      <input type="checkbox" id="intervalToggle" value="" class="sr-only peer">
                      <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                      <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300">1hr</span>
                    </label>

                    <button
                      id="refresh-btn"
                      class="px-2 py-1 mr-1 inline-flex items-center gap-x-1 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
                    >
                      <svg
                        class="w-4 h-4 text-gray-800 dark:text-white"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke="currentColor"
                          stroke-linecap="round"
                          stroke-width="2"
                          d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"
                        />
                      </svg>

                      Search
                    </button>
                    <button
                      id="clear-btn"
                      class="px-2 py-1 mr-1 inline-flex items-center gap-x-1 text-sm font-semibold rounded-lg border border-transparent bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 disabled:pointer-events-none dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
                    >
                      <svg
                        class="w-4 h-4 text-gray-800 dark:text-white"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke="currentColor"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17.651 7.65a7.131 7.131 0 0 0-12.68 3.15M18.001 4v4h-4m-7.652 8.35a7.13 7.13 0 0 0 12.68-3.15M6 20v-4h4"
                        />
                      </svg>

                      Clear
                    </button>
                    <button
                      id="download-btn"
                      class="px-2 py-1 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-gray-200 text-gray-500 hover:border-blue-600 hover:text-blue-600 disabled:opacity-50 disabled:pointer-events-none dark:border-gray-700 dark:text-gray-400 dark:hover:text-blue-500 dark:hover:border-blue-600 dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
                    >
                      <svg
                        class="w-4 h-4 text-gray-800 dark:text-white"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke="currentColor"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 13V4M7 14H5a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-2m-1-5-4 5-4-5m9 8h.01"
                        />
                      </svg>
                    </button>
                  </div>

                </div>
                <div
                  class="bg-white grow border rounded-lg"
                  id="vis-container"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script type="module">
        import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";
        let runID = {{ run.id }};
        let locationName = "{{ location.name }}";
        let dateButtonDiv = document.getElementById('accordion');
        let visContainer = document.getElementById('vis-container');
        let colorMap = {
          "Substandard": "{{ colors.orange}}",
          "Satisfactory": "{{ colors.green}}",
          "Unsatisfactory": "{{ colors.red}}",
      }
        let earliest;
        let latest;
        // Get range of dates for the visualisation
        async function getRange() {
          if (earliest !== undefined || latest !== undefined) {
            return [earliest, latest];
          }
          try {
            const response = await fetch(`/api/results/timeseries/range?runID=${runID}`);
            const range = await response.json();
            // get earliest and latest date from range
            earliest = new Date(range.earliest_datetime);
            latest = new Date(range.latest_datetime);
            return [earliest, latest];

          } catch (error) {
            console.error('Error fetching data:', error);
          }
        }
        async function populatePage(){
          const [earliest, latest] = await getRange();
          const monthRange = [];
          var currentDate = new Date(earliest);
          while (currentDate <= latest) {
            monthRange.push(new Date(currentDate));
            currentDate.setMonth(currentDate.getMonth() + 1);
          }
          // Remove loading indiators
          document.getElementById('start-option-loading').remove();
          document.getElementById('end-option-loading').remove();

          const start_selector = document.getElementById('start-selector')
          const end_selector = document.getElementById('end-selector')
          monthRange.forEach((month) => {
            const monthOption = document.createElement('option')
            monthOption.innerHTML = `${month.toLocaleString('default', { month: 'long' })} ${month.getFullYear()}`;
            monthOption.value = (month.getTime()/1000);
            const startOption = monthOption.cloneNode(true);
            start_selector.appendChild(startOption);

            const endOption = monthOption.cloneNode(true);
            end_selector.appendChild(endOption);
          })
        generatePlot();
        }
        async function generatePlot(){
          const start_selector = document.getElementById('start-selector')
          const end_selector = document.getElementById('end-selector')
          let startDate = parseInt(start_selector.value);
          let endDate = parseInt(end_selector.value);
          if (startDate > endDate) {
            alert('Start date must be before end date');
            return;
          }
          // if start date is equal to end date, set end date to start date plus one month
          if (startDate === endDate) {
            endDate = startDate + 2678400;
          }
          // if range is greater than 1 year, alert user and return
          if (endDate - startDate > 31536000) {
            alert('Date range must be less than 1 year');
            return;
          }
          let intervalToggle = document.getElementById('intervalToggle');
          let url;
          if (intervalToggle.checked) {
            url = (`/api/results/timeseries?runID=${runID}&startTime=${startDate}&endTime=${endDate}&reduce`)
          } else {
            url = (`/api/results/timeseries?runID=${runID}&startTime=${startDate}&endTime=${endDate}`)
          }
          let data = await fetch(url);
          data = await data.json();
          data.forEach(d => {
            d.dateTime = new Date(d.dateTime);
            d.intensity = parseFloat(d.intensity);
            d.result = JSON.parse(JSON.parse(d.result));
          });
          let marks = [
              Plot.lineY(data, {
                x: "dateTime",
                y: "intensity",
                stroke: "{{colors.blue}}",
                channels: {
                  Classification: "classification",
                  dateTime: d => d.dateTime.toLocaleString(),
                  Spill_Allowed: d => (d.spillAllowed === "YES" ? "Yes" : "No"),
                  Assets: d => {
                    return Object.entries(d.result).filter(([key, val]) => val === "YES").map(([key, val]) => `${key}\n`)
                  }
                },
                tip: true
              }),
              Plot.ruleX(data, {
                x: "dateTime",
                y: -1,
                stroke: d => colorMap[d.classification],
                title: d => d.classification
              }),
              Plot.ruleX(data, {
                x: "dateTime",
                y1: -1,
                y2: -2,
                stroke: (d) => (d.spillAllowed === "YES" ? "{{colors.purple}}" : "white"),
              }),
              Plot.ruleY([4], {stroke: "red"}),
              Plot.crosshair(data, {
                x: d => d.dateTime,
                y: d => d.intensity
              })
            ];
            let count = -3;
            for(const result in (data[0].result)){
              console.log(result);
              marks.push(
                Plot.ruleX(data, {
                  x: "dateTime",
                  y1: count,
                  y2: count - 1,
                  stroke: d => (d.result[result] === "YES" ? count : "white"),
                })
              )
              marks.push(
                Plot.text([result],{
                  y: count,
                  frameAnchor: "left",
                  dx: -130,
                  dy: 10,
                })
              )
              count--;
              count--;
            }
            
          console.log(marks);
          const plot = Plot.plot({
            x: { type: "utc" },
            y: { label: "Intensity(mm)" },
            color: {scheme: "BuRd"},
            marks: marks,
            marginLeft: 135,
          });
          const div = document.querySelector("#vis-container");
          div.innerHTML = '';
          plot.classList.add('w-full');
          div.appendChild(plot);
        }
        // Button event listeners
        document.getElementById('refresh-btn').addEventListener('click', () => generatePlot());
        document.getElementById('intervalToggle').addEventListener('change', () => generatePlot());
        document.getElementById('clear-btn').addEventListener('click', () => {
          document.getElementById('start-selector').selectedIndex  = 0;
          document.getElementById('end-selector').selectedIndex  = 0;
          generatePlot();
        });
        document.getElementById('download-btn').addEventListener('click', () => {
          const start_selector = document.getElementById('start-selector')
          const end_selector = document.getElementById('end-selector')
          const vis_container = document.getElementById('vis-container');
          const svg_element = vis_container.querySelector('svg');
          let startDate = parseInt(start_selector.value);
          let endDate = parseInt(end_selector.value);
          if (startDate > endDate) {
            alert('Start date must be before end date');
            return;
          }
          // if start date is equal to end date, set end date to start date plus one month
          if (startDate === endDate) {
            endDate = startDate + 2678400;
          }
          // if range is greater than 1 year, alert user and return
          if (endDate - startDate > 31536000) {
            alert('Date range must be less than 1 year');
            return;
          }
          // Create a Blob object with the SVG data
          const svgData = new XMLSerializer().serializeToString(svg_element);
          const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
          // Create a temporary link element
          const tempLink = document.createElement('a');
          tempLink.href = window.URL.createObjectURL(svgBlob);
          tempLink.download = `${locationName}-${startDate}_to_${endDate}-rainfall_visualisation.svg`;
          document.body.appendChild(tempLink);
          tempLink.click();
          document.body.removeChild(tempLink);
          });
        window.addEventListener("load", (event) => {
          getRange();
          populatePage();
        });
    </script>
  </body>
</html>
